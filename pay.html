<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - ShonkuWeb Pay</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="protect.js"></script>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1 class="title">Scan to Pay</h1>
            <p class="subtitle">Please scan the QR code below to complete your payment.</p>

            <div class="qr-container">
                <!-- Dynamic QR Code for UPI Payment -->
                <img id="payment-qr" src="" alt="Payment QR Code" class="qr-code">
            </div>

            <div id="amount-display" class="amount-display"></div>

            <script>
                // Get current user from session storage
                const currentUser = sessionStorage.getItem('currentUser');

                // Get amount from CONFIG if user exists, otherwise fallback to session storage or default
                let amount = '1';
                let userAuthCode = '1234'; // Default fallback code

                if (currentUser && CONFIG.users[currentUser]) {
                    amount = CONFIG.users[currentUser].amount;
                    userAuthCode = CONFIG.users[currentUser].code;
                } else {
                    amount = sessionStorage.getItem('paymentAmount') || '1';
                }

                // Format amount to 2 decimal places
                const formattedAmount = parseFloat(amount).toFixed(2);

                // Display the amount
                const amountDisplay = document.getElementById('amount-display');
                amountDisplay.textContent = `â‚¹${formattedAmount}`;

                // Minimal UPI URL to avoid "risky transaction" warnings
                // Only mandatory parameters: pa (address), pn (name), am (amount), cu (currency)
                const upiUrl = `upi://pay?pa=6295175749-1@okbizaxis&pn=ShonkuWeb&am=${formattedAmount}&cu=INR`;

                // Generate QR Code URL with Transparency
                // dark=ffffff (White Dots), light=00000000 (Transparent Background)
                const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(upiUrl)}&dark=ffffff&light=00000000&margin=1&size=250`;

                // Set image source
                document.getElementById('payment-qr').src = qrUrl;

                function verifyPayment() {
                    const enteredCode = document.getElementById('auth-code').value;
                    const errorMsg = document.getElementById('auth-error');

                    if (enteredCode === userAuthCode) {
                        window.location.href = 'details.html';
                    } else {
                        errorMsg.style.display = 'block';
                        // Shake animation
                        const input = document.getElementById('auth-code');
                        input.style.animation = 'none';
                        input.offsetHeight; /* trigger reflow */
                        input.style.animation = 'shake 0.5s';
                    }
                }

                // Allow Enter key to submit
                document.getElementById('auth-code').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        verifyPayment();
                    }
                });
            </script>

            <div id="amount-display" class="amount-display"></div>

            <div class="auth-section">
                <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.9rem;">Enter 4-digit Code to
                    Proceed</p>
                <input type="text" id="auth-code" maxlength="4" placeholder="0000" class="auth-input"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <p id="auth-error" class="error-msg" style="margin-top: 8px;">Invalid Code</p>
            </div>

            <button onclick="verifyPayment()" class="submit-btn" style="margin-top: 24px;">
                Proceed to Details
            </button>
        </div>
    </div>
</body>

</html>